<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Cleaning Toolkit</title>
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <style>
        body{font-family:Arial,sans-serif;max-width:1200px;margin:0 auto;padding:20px;background:#f9f9f9;color:#333}
        h1{margin-top:0;border-bottom:2px solid #333;padding-bottom:10px}
        .section{background:#fff;margin:20px 0;padding:20px;border:1px solid #ddd;border-radius:4px}
        .section h2{margin-top:0;font-size:18px;color:#333;border-bottom:1px solid #eee;padding-bottom:10px}
        .section p{margin:10px 0;font-size:14px;color:#666}
        .button-group{margin:15px 0;display:flex;flex-wrap:wrap;gap:10px}
        button{padding:10px 15px;background:#333;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px}
        button:hover{background:#555}
        button:disabled{background:#ccc;cursor:not-allowed}
        textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-family:monospace;font-size:12px;box-sizing:border-box}
        input[type="file"]{padding:10px;border:1px solid #ddd;border-radius:4px}
        #results{background:#f0f0f0;padding:15px;border-radius:4px;overflow-x:auto;max-height:400px;overflow-y:auto;margin-top:10px}
        #detectionResults{background:#e8f4f8;padding:15px;border-radius:4px;margin-top:10px;border-left:4px solid #0066cc}
        #auditLog{margin-top:10px}
        #auditLog table{width:100%;border-collapse:collapse;background:#fff}
        #auditLog th,#auditLog td{padding:10px;text-align:left;border-bottom:1px solid #ddd}
        #auditLog th{background:#f0f0f0;font-weight:bold}
        .comparison-container{display:flex;gap:20px;margin-top:15px}
        .comparison-column{flex:1}
        .comparison-column h4{margin-top:0}
        .comparison-column div{max-height:300px;overflow-y:auto;border:1px solid #ddd;padding:10px;background:#f9f9f9;border-radius:4px}
        #tableView{margin-top:20px}
        #tableView table{width:100%;border-collapse:collapse;background:#fff}
        #tableView th,#tableView td{padding:8px;text-align:left;border:1px solid #ddd;font-size:12px}
        #tableView th{background:#f0f0f0;font-weight:bold;cursor:pointer}
        #tableView th:hover{background:#e0e0e0}
        .highlight-missing{background:#ffcccc}
        .highlight-whitespace{background:#ffffcc}
        @media(max-width:768px){body{padding:10px}.section{padding:15px}.button-group{flex-direction:column}}
    </style>
    <h1>Data Cleaning Toolkit</h1>
    <p style="color:#666;margin-bottom:20px">Automated, transparent, privacy-first data cleaning. Upload a CSV file and clean your data in seconds.</p>
    <div class="section">
        <h2>1. Upload Data</h2>
        <p>Paste CSV data below or upload a file:</p>
        <textarea id="csvInput" rows="8" placeholder="Paste CSV data here, or upload a file below"></textarea>
        <div style="margin-top:10px">
            <label>Or upload CSV file: <input type="file" id="fileInput" accept=".csv"></label>
        </div>
        <div class="button-group">
            <button id="installBtn" style="display:none">Install App</button>
        </div>
    </div>
    <div class="section">
        <h2>2. Detect Issues</h2>
        <p>Analyze your data to find quality issues:</p>
        <div class="button-group">
            <button id="autoDetectBtn" style="display:none" onclick="autoDetect()">Auto Detect All Issues</button>
            <button onclick="detectMissing()">Detect Missing Values</button>
            <button onclick="detectDuplicates()">Detect Duplicates</button>
            <button onclick="detectWhitespace()">Detect Whitespace</button>
            <button onclick="detectNullValues()">Detect Null Values</button>
        </div>
        <div id="detectionResults"></div>
    </div>
    <div class="section">
        <h2>3. Clean Data</h2>
        <p>Apply cleaning operations to fix issues:</p>
        <div class="button-group">
            <button id="autoCleanBtn" style="display:none" onclick="autoClean()">Auto Clean (Recommended)</button>
            <button onclick="cleanData()">Remove Duplicates</button>
            <button onclick="trimWhitespace()">Trim Whitespace</button>
            <button onclick="standardiseNullValues()">Standardise Null Values</button>
            <button onclick="toUpperCase()">Convert to Uppercase</button>
            <button onclick="toLowerCase()">Convert to Lowercase</button>
        </div>
    </div>
    <div class="section">
        <h2>4. View Results</h2>
        <p>Examine your cleaned data and operation details:</p>
        <div class="button-group">
            <button id="comparisonBtn" style="display:none" onclick="displayComparison()">View Before/After</button>
            <button id="tableBtn" style="display:none" onclick="displayTableView()">View Data Table</button>
            <button id="auditLogBtn" style="display:none" onclick="displayAuditLog()">View Audit Log</button>
        </div>
        <div id="results"></div>
    </div>
    <div class="section">
        <h2>5. Download Results</h2>
        <p>Save your cleaned data:</p>
        <div class="button-group">
            <button id="downloadBtn" style="display:none" onclick="downloadCSV()">Download Cleaned CSV</button>
        </div>
    </div>
    <div id="comparisonView" style="display:none" class="section">
        <h2>Before/After Comparison</h2>
        <p>Compare original and cleaned data side-by-side:</p>
        <div class="comparison-container">
            <div class="comparison-column">
                <h4>Original Data</h4>
                <div id="originalDataTable"></div>
            </div>
            <div class="comparison-column">
                <h4>Cleaned Data</h4>
                <div id="cleanedDataTable"></div>
            </div>
        </div>
        <div id="comparisonStats" style="margin-top:20px;padding:15px;background:#e8f4f8;border-radius:4px;border-left:4px solid #0066cc"></div>
    </div>
    <div id="tableView" style="display:none" class="section">
        <h2>Data Table View</h2>
        <p>Browse your data in a structured table format:</p>
        <div style="margin-bottom:15px">
            <label>Rows per page: <select id="rowsPerPage" onchange="updateTableView()" style="padding:8px;border:1px solid #ddd;border-radius:4px"><option>50</option><option>100</option><option>200</option></select></label>
            <span id="tablePageInfo" style="margin-left:20px;font-size:14px;color:#666"></span>
        </div>
        <div style="overflow-x:auto;max-height:500px;overflow-y:auto;border:1px solid #ddd;border-radius:4px">
            <table id="dataTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div class="button-group" style="margin-top:15px">
            <button onclick="previousPage()">Previous Page</button>
            <button onclick="nextPage()">Next Page</button>
        </div>
    </div>
    <script src="algorithms.js"></script>
    <script>
        let wasmModule=null;
        let wasmReady=false;
        AlgorithmsModule().then(module=>{wasmModule=module;wasmReady=true;});
    </script>
    <script>
        const API_URL=window.location.origin;
        function showResult(data){document.getElementById('results').innerHTML='<pre>'+JSON.stringify(data,null,2)+'</pre>'}
        async function parseCSV(){const csv=document.getElementById('csvInput').value;if(wasmReady){const rows=wasmModule.ccall('parseCSV','number',['string'],[csv]);showResult({rows:rows,message:'CSV parsed successfully (offline)',mode:'wasm'})}else{const res=await fetch(API_URL+'/api/parse',{method:'POST',body:csv});const data=await res.json();data.mode='api';showResult(data)}}
        async function detectMissing(){const csv=document.getElementById('csvInput').value;if(wasmReady){const missing=wasmModule.ccall('detectMissing','number',['string'],[csv]);showResult({missing:missing,message:'Missing values detected successfully (offline)',mode:'wasm'})}else{const res=await fetch(API_URL+'/api/detect-missing',{method:'POST',body:csv});const data=await res.json();data.mode='api';showResult(data)}}
        async function detectDuplicates(){const csv=document.getElementById('csvInput').value;if(wasmReady){const duplicates=wasmModule.ccall('detectDuplicates','number',['string'],[csv]);showResult({duplicates:duplicates,message:'Duplicate rows detected successfully (offline)',mode:'wasm'})}else{const res=await fetch(API_URL+'/api/detect-duplicates',{method:'POST',body:csv});const data=await res.json();data.mode='api';showResult(data)}}
        async function cleanData(){const csv=document.getElementById('csvInput').value;if(wasmReady){const cleanedRows=wasmModule.ccall('cleanData','number',['string'],[csv]);const originalRows=wasmModule.ccall('parseCSV','number',['string'],[csv]);cleanedCSV=wasmModule.ccall('cleanDataString','string',['string'],[csv]);showResult({originalRows:originalRows,cleanedRows:cleanedRows,removedRows:originalRows-cleanedRows,message:'Data cleaned successfully (offline)',mode:'wasm'})}else{const res=await fetch(API_URL+'/api/clean',{method:'POST',body:csv});const data=await res.json();cleanedCSV=data.cleaned;data.mode='api';showResult(data)};document.getElementById('downloadBtn').style.display='inline-block';document.getElementById('auditLogBtn').style.display='inline-block';document.getElementById('comparisonBtn').style.display='inline-block';document.getElementById('tableBtn').style.display='inline-block'}
    </script>
    <script>
        let deferredPrompt;window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;document.getElementById('installBtn').style.display='inline-block'});document.getElementById('installBtn').addEventListener('click',async()=>{if(deferredPrompt){deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;deferredPrompt=null;document.getElementById('installBtn').style.display='none'}});
    </script>
    <script>
        if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js').then(registration=>{console.log('Service Worker registered with scope:',registration.scope);}).catch(error=>{console.log('Service Worker registration failed:',error);});}
    </script>
    <script>
        let uploadCSV='';
        let cleanedCSV='';
        document.getElementById('fileInput').addEventListener('change',async(e)=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=async(e)=>{uploadCSV=e.target.result;document.getElementById('csvInput').value=uploadCSV;document.getElementById('autoDetectBtn').style.display='inline-block'};reader.readAsText(file);}});
        async function autoDetect(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            const results={};
            if(wasmReady){results.rows=wasmModule.ccall('parseCSV','number',['string'],[uploadCSV]);results.missing=wasmModule.ccall('detectMissing','number',['string'],[uploadCSV]);results.duplicates=wasmModule.ccall('detectDuplicates','number',['string'],[uploadCSV]);results.message='Auto-detection completed successfully (offline)';results.mode='wasm'}
            else{
                const parseRes=await fetch(API_URL+'/api/parse',{method:'POST',body:uploadCSV});
                const parseData=await parseRes.json();
                results.rows=parseData.rows;
                const missingRes=await fetch(API_URL+'/api/detect-missing',{method:'POST',body:uploadCSV});
                const missingData=await missingRes.json();
                results.missing=missingData.missing;
                const dupRes=await fetch(API_URL+'/api/detect-duplicates',{method:'POST',body:uploadCSV});
                const dupData=await dupRes.json();
                results.duplicates=dupData.duplicates;                
            }
            document.getElementById('detectionResults').innerHTML='<h4>detection results:</h4><p>total rows: '+results.rows+'</p><p>missing values: '+results.missing+'</p><p>duplicate rows: '+results.duplicates+'</p>';
            if(results.duplicates>0||results.missing>0){document.getElementById('autoCleanBtn').style.display='inline-block'}
        }
        async function autoClean(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            if(wasmReady){cleanedRows=wasmModule.ccall('cleanData','number',['string'],[uploadCSV]);cleanedCSV=wasmModule.ccall('cleanDataString','string',['string'],[uploadCSV]);showResult({message:'data cleaned automatically',cleanedRows:cleanedRows,mode:'wasm'});}
            else{
                const res=await fetch(API_URL+'/api/clean',{method:'POST',body:uploadCSV});
                const data=await res.json();
                cleanedCSV=uploadCSV;
                showResult(data);
            }
            document.getElementById('downloadBtn').style.display='inline-block';
            document.getElementById('auditLogBtn').style.display='inline-block';
            document.getElementById('comparisonBtn').style.display='inline-block';
            document.getElementById('tableBtn').style.display='inline-block';
        }
        async function detectWhitespace(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            if(wasmReady){let count=wasmModule.ccall('detectWhitespace','number',['string'],[uploadCSV]);showResult({message:'whitespace detected',cellsWithWhitespace:count,mode:'wasm'});
            }else{
                let res=await fetch('/api/detect-whitespace',{method:'POST',headers:{'Content-Type':'text/plain'},body:uploadCSV});
                let data=await res.json();
                showResult(data);
            }
        }
        async function trimWhitespace(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            if(wasmReady){let count=wasmModule.ccall('detectWhitespace','number',['string'],[uploadCSV]);cleanedCSV=wasmModule.ccall('trimWhitespaceString','string',['string'],[uploadCSV]);showResult({message:'whitespace trimmed',cellsTrimmed:count,mode:'wasm'});
            }else{
                let res=await fetch('/api/trim-whitespace',{method:'POST',headers:{'Content-Type':'text/plain'},body:uploadCSV});
                let data=await res.json();
                cleanedCSV=data.cleaned;
                showResult(data);
            }
            document.getElementById('downloadBtn').style.display='inline-block';
            document.getElementById('auditLogBtn').style.display='inline-block';
            document.getElementById('comparisonBtn').style.display='inline-block';
            document.getElementById('tableBtn').style.display='inline-block';
        }
        async function toUpperCase(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            if(wasmReady){cleanedCSV=wasmModule.ccall('toUpperCaseString','string',['string'],[uploadCSV]);showResult({message:'converted to uppercase',mode:'wasm'});
            }else{
                let res=await fetch('/api/to-uppercase',{method:'POST',headers:{'Content-Type':'text/plain'},body:uploadCSV});
                let data=await res.json();
                cleanedCSV=data.cleaned;
                showResult(data);
            }
            document.getElementById('downloadBtn').style.display='inline-block';
            document.getElementById('auditLogBtn').style.display='inline-block';
            document.getElementById('comparisonBtn').style.display='inline-block';
            document.getElementById('tableBtn').style.display='inline-block';
        }
        async function toLowerCase(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            if(wasmReady){cleanedCSV=wasmModule.ccall('toLowerCaseString','string',['string'],[uploadCSV]);showResult({message:'converted to lowercase',mode:'wasm'});
            }else{
                let res=await fetch('/api/to-lowercase',{method:'POST',headers:{'Content-Type':'text/plain'},body:uploadCSV});
                let data=await res.json();
                cleanedCSV=data.cleaned;
                showResult(data);
            }
            document.getElementById('downloadBtn').style.display='inline-block';
            document.getElementById('auditLogBtn').style.display='inline-block';
            document.getElementById('comparisonBtn').style.display='inline-block';
            document.getElementById('tableBtn').style.display='inline-block';
        }
        async function detectNullValues(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            if(wasmReady){let count=wasmModule.ccall('detectNullValues','number',['string'],[uploadCSV]);showResult({message:'null values detected',cellsWithNullValues:count,mode:'wasm'});
            }else{
                let res=await fetch('/api/detect-null-values',{method:'POST',headers:{'Content-Type':'text/plain'},body:uploadCSV});
                let data=await res.json();
                showResult(data);
            }
        }

        async function standardiseNullValues(){
            if(!uploadCSV){alert('upload a csv file first!');return;}
            if(wasmReady){let count=wasmModule.ccall('detectNullValues','number',['string'],[uploadCSV]);cleanedCSV=wasmModule.ccall('standardiseNullValueString','string',['string'],[uploadCSV]);showResult({message:'null values standardised',cellsstandardised:count,mode:'wasm'});
            }else{
                let res=await fetch('/api/standardise-null-values',{method:'POST',headers:{'Content-Type':'text/plain'},body:uploadCSV});
                let data=await res.json();
                cleanedCSV=data.cleaned;
                showResult(data);
            }
            document.getElementById('downloadBtn').style.display='inline-block';
            document.getElementById('auditLogBtn').style.display='inline-block';
            document.getElementById('comparisonBtn').style.display='inline-block';
            document.getElementById('tableBtn').style.display='inline-block';
        }
        async function displayAuditLog(){
            if(wasmReady){showResult({message:'Audit log not available in WASM mode (offline)',mode:'wasm'});return;}
            const res=await fetch(API_URL+'/api/get-audit-log',{method:'GET'});
            const data=await res.json();
            let html='<h3>Audit Log</h3><table border="1" cellpadding="5"><tr><th>Operation</th><th>Cells Affected</th><th>Rows Before</th><th>Rows After</th><th>Timestamp</th></tr>';
            for(const op of data.operations){html+='<tr><td>'+op.operationName+'</td><td>'+op.cellsAffected+'</td><td>'+op.rowsBefore+'</td><td>'+op.rowsAfter+'</td><td>'+op.timestamp+'</td></tr>';}
            html+='</table>';
            document.getElementById('auditLog').innerHTML=html;
        }
        function displayComparison(){
            if(!uploadCSV || !cleanedCSV){alert('perform a cleaning operation first!');return;}
            const originalRows=uploadCSV.split('\n').filter(r=>r.trim()).length;
            const cleanedRows=cleanedCSV.split('\n').filter(r=>r.trim()).length;
            const removedRows=originalRows-cleanedRows;
            let originalHtml='<pre style="font-size:12px;white-space:pre-wrap;word-wrap:break-word">'+uploadCSV.substring(0,500)+'...</pre>';
            let cleanedHtml='<pre style="font-size:12px;white-space:pre-wrap;word-wrap:break-word">'+cleanedCSV.substring(0,500)+'...</pre>';
            let statsHtml='<h4>Statistics</h4><table border="1" cellpadding="5"><tr><th>Metric</th><th>Before</th><th>After</th><th>Change</th></tr>';
            statsHtml+='<tr><td>Rows</td><td>'+originalRows+'</td><td>'+cleanedRows+'</td><td>-'+removedRows+'</td></tr>';
            statsHtml+='</table>';
            document.getElementById('originalDataTable').innerHTML=originalHtml;
            document.getElementById('cleanedDataTable').innerHTML=cleanedHtml;
            document.getElementById('comparisonStats').innerHTML=statsHtml;
            document.getElementById('comparisonView').style.display='block';
        }
        let currentPage=0;
        let tableData=[];
        let rowsPerPageValue=50;

        function parseCSVToArray(csv){
            const rows=[];
            const lines=csv.split('\n');
            for(let i=0;i<lines.length;i++){
                if(lines[i].trim()){
                    const cells=[];
                    let current='';
                    let inQuotes=false;
                    for(let j=0;j<lines[i].length;j++){
                        const char=lines[i][j];
                        if(char==='"'){inQuotes=!inQuotes;}
                        else if(char===',' && !inQuotes){cells.push(current.trim());current='';}
                        else{current+=char;}
                    }
                    cells.push(current.trim());
                    rows.push(cells);
                }
            }
            return rows;
        }

        function displayTableView(){
            if(!cleanedCSV){alert('perform a cleaning operation first!');return;}
            tableData=parseCSVToArray(cleanedCSV);
            currentPage=0;
            rowsPerPageValue=parseInt(document.getElementById('rowsPerPage').value);
            updateTableView();
            document.getElementById('tableView').style.display='block';
        }

        function updateTableView(){
            if(tableData.length===0)return;
            rowsPerPageValue=parseInt(document.getElementById('rowsPerPage').value);
            const headers=tableData[0];
            const startRow=currentPage*rowsPerPageValue+1;
            const endRow=Math.min((currentPage+1)*rowsPerPageValue,tableData.length-1);
            const totalPages=Math.ceil((tableData.length-1)/rowsPerPageValue);
            let headerHtml='<tr>';
            for(let i=0;i<headers.length;i++){headerHtml+='<th style="background:#f0f0f0;cursor:pointer" onclick="sortByColumn('+i+')">'+headers[i]+'</th>';}
            headerHtml+='</tr>';
            document.getElementById('tableHead').innerHTML=headerHtml;
            let bodyHtml='';
            for(let i=startRow;i<=endRow;i++){
                bodyHtml+='<tr>';
                for(let j=0;j<tableData[i].length;j++){
                    const cell=tableData[i][j];
                    let cellStyle='';
                    if(cell==='' || cell==='null' || cell==='NULL'){cellStyle='background:#ffcccc';}
                    else if(cell.match(/^\s+|\s+$/)){cellStyle='background:#ffffcc';}
                    bodyHtml+='<td style="'+cellStyle+'">'+cell+'</td>';
                }
                bodyHtml+='</tr>';
            }
            document.getElementById('tableBody').innerHTML=bodyHtml;
            document.getElementById('tablePageInfo').innerHTML='Page '+(currentPage+1)+' of '+totalPages+' (rows '+startRow+'-'+endRow+' of '+(tableData.length-1)+')';
        }

        function nextPage(){
            const totalPages=Math.ceil((tableData.length-1)/rowsPerPageValue);
            if(currentPage<totalPages-1){currentPage++;updateTableView();}
        }

        function previousPage(){
            if(currentPage>0){currentPage--;updateTableView();}
        }

        function sortByColumn(colIndex){
            tableData.sort((a,b)=>{if(a[colIndex]<b[colIndex])return -1;if(a[colIndex]>b[colIndex])return 1;return 0;});
            currentPage=0;
            updateTableView();
        }
        function downloadCSV(){const blob=new Blob([cleanedCSV],{type:'text/csv'});const url=window.URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='cleaned.csv';a.click();window.URL.revokeObjectURL(url);}
    </script>
</body>
</html>