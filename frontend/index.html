<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <meta name="description" content="A privacy-first, browser-based data cleaning toolkit that runs offline using WebAssembly (Wasm). Detect missing values, duplicates, and clean CSV data with transparent algorithms.">
	    <meta name="robots" content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1">
		    <meta name="theme-color" content="#f4f4f4">
	    <title>Data Cleaning Toolkit | Calum Kerr</title>
	    <link rel="canonical" href="https://www.calumkerr.com/app">
	    <meta property="og:type" content="website">
	    <meta property="og:title" content="Data Cleaning Toolkit | Calum Kerr">
	    <meta property="og:site_name" content="Calum Kerr">
	    <meta property="og:locale" content="en_GB">
	    <meta property="og:description" content="Privacy-first CSV cleaning in your browser. Transparent algorithms. Offline-first via WebAssembly.">
	    <meta property="og:url" content="https://www.calumkerr.com/app">
	    <meta property="og:image" content="https://www.calumkerr.com/android-chrome-512x512.png">
	    <meta property="og:image:width" content="512">
	    <meta property="og:image:height" content="512">
	    <meta property="og:image:alt" content="Data Cleaning Toolkit app icon">
	    <meta name="twitter:card" content="summary">
	    <meta name="twitter:title" content="Data Cleaning Toolkit | Calum Kerr">
	    <meta name="twitter:description" content="Privacy-first CSV cleaning in your browser. Transparent algorithms. Offline-first via WebAssembly.">
	    <meta name="twitter:image" content="https://www.calumkerr.com/android-chrome-512x512.png">
	    <meta name="twitter:image:alt" content="Data Cleaning Toolkit app icon">
	    <link rel="icon" href="/favicon.ico">
	    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
	    <script type="application/ld+json">{"@context":"https://schema.org","@type":"SoftwareApplication","name":"Data Cleaning Toolkit","applicationCategory":"BusinessApplication","operatingSystem":"Web","description":"A privacy-first, browser-based data cleaning toolkit that runs offline using WebAssembly (Wasm). Detect missing values, duplicates, and clean CSV data with transparent algorithms.","url":"https://www.calumkerr.com/app","creator":{"@type":"Person","name":"Calum Kerr","url":"https://www.calumkerr.com"},"offers":{"@type":"Offer","price":"0","priceCurrency":"GBP"}}</script>
	    <link rel="manifest" href="/manifest.json">
	    <style>
	        :root{--c60:#f4f4f4;--c30:#ffffff;--c10:#0000ee;--t:#111;--muted:#555;--line:#d9d9d9}
	        body{margin:0;background:var(--c60);color:var(--t);font:14px/1.45 Arial,Helvetica,sans-serif}
	        a{color:var(--c10);text-decoration:underline}
	        a:focus{outline:2px dotted #000;outline-offset:2px}
	        .wrap{max-width:980px;margin:0 auto;padding:18px}
	        .topnav{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:0 0 10px 0}
	        .topnav a{display:inline-block;padding:4px 8px;border:1px solid var(--line);background:var(--c30)}
	        h1{margin:0 0 10px 0;text-align:center;color:var(--t);font-size:22px}
	        .panel{background:var(--c30);border:1px solid var(--line);padding:14px;margin:12px 0}
	        .welcome-section{text-align:center}
	        .welcome-section h2{margin:0 0 10px 0;color:var(--t);font-size:16px}
	        .cta-buttons{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:10px}
	        .cta-button{padding:10px 14px;background:#fff;color:var(--c10);border:1px solid var(--line);cursor:pointer;font-size:14px;min-width:180px}
	        .cta-button:hover{background:#f0f0f0}
	        .cta-button.coming-soon{color:var(--muted);cursor:not-allowed}
	        .cta-button.coming-soon:hover{background:#fff}
	        .structured-section{display:none}
	        .section-title{margin:0 0 10px 0;color:var(--t);border-bottom:1px solid var(--line);padding-bottom:8px;font-size:16px}
	        .upload-area{border:2px dashed var(--line);padding:18px;text-align:center;margin:12px 0}
	        .upload-area.drag-over{border-color:var(--c10);background:#f0f0f0}
	        .upload-options{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap}
	        .upload-option{padding:8px 10px;background:#fff;border:1px solid var(--line);cursor:pointer;color:var(--t)}
	        .upload-option:hover{background:#f0f0f0}
	        textarea{width:100%;padding:10px;border:1px solid var(--line);font-family:Consolas,Monaco,monospace;font-size:12px;box-sizing:border-box;min-height:200px;resize:vertical}
	        .profile-section{display:none}
	        .profile-details{margin:10px 0;padding:10px;border:1px solid var(--line);background:#fafafa}
	        .issues-list{margin:10px 0;padding:10px;border:1px solid var(--line);background:#fff}
	        .cleaning-section{display:none}
	        .progress-container{margin:12px 0;background:#fff;border:1px solid var(--line);height:18px;overflow:hidden}
	        .progress-bar{height:100%;background:var(--c10);width:0%}
	        .settings-section{margin:12px 0;padding:10px;border:1px solid var(--line);background:#fafafa}
	        .setting-option{margin:8px 0}
	        .result-section{display:none}
	        .success-message{text-align:center;padding:14px;border:1px solid var(--line);background:#fafafa;color:var(--t);margin:12px 0}
	        .hidden{display:none}
	        .results-grid{display:grid;grid-template-columns:1fr;gap:14px}
	        @media (min-width:840px){.results-grid{grid-template-columns:1fr 1fr}}
	        @media (max-width:768px){.wrap{padding:10px}.cta-button{width:100%;max-width:320px}}
        .data-table-container{margin:20px 0;border:1px solid var(--line);background:#fff;overflow-x:auto}
        .data-table{width:100%;border-collapse:collapse;font-size:13px}
        .data-table th{background:#f4f4f4;border:1px solid var(--line);padding:8px;text-align:left;font-weight:bold;color:var(--t)}
        .data-table td{border:1px solid var(--line);padding:8px;color:var(--t)}
        .data-table tr:nth-child(even){background:#fafafa}
        .data-table tr:hover{background:#f0f0f0}
        .table-controls{padding:10px;background:#f4f4f4;border-bottom:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .table-controls input{padding:6px;border:1px solid var(--line);font-size:13px}
        .table-pagination{padding:10px;background:#f4f4f4;border-top:1px solid var(--line);text-align:center;font-size:13px}
        .table-pagination button{padding:6px 10px;margin:0 4px;border:1px solid var(--line);background:#fff;cursor:pointer}
        .table-pagination button:hover{background:#f0f0f0}
        .table-pagination button:disabled{color:var(--muted);cursor:not-allowed}
        .modified-cell{background:#fff3cd;color:#856404}
	    </style>
</head>
	<body>
	  <div class="wrap">
	    <nav class="topnav" aria-label="site">
	      <a href="/">home</a>
		      <a href="/features">features</a>
		      <a href="/honours-project">honours project</a>
	      <a href="https://github.com/Calum-Kerr/data-cleaning-toolkit" rel="noopener" target="_blank">github</a>
	      <a href="https://www.linkedin.com/in/kerr-x-calum/" rel="noopener" target="_blank">linkedin</a>
	      <a href="https://github.com/Calum-Kerr/data-cleaning-toolkit/issues/new/choose" rel="noopener" target="_blank">report a bug / request a feature</a>
	      <a href="https://github.com/Calum-Kerr/data-cleaning-toolkit/discussions" rel="noopener" target="_blank">discussions</a>
	    </nav>
	    <h1>Data Cleaning Toolkit</h1>
	    <main role="main">
	    <div class="welcome-section panel" id="welcomeSection">
        <h2>Choose Your Data Type</h2>
        <p>Select the type of data you want to clean:</p>
        <div class="cta-buttons">
            <button class="cta-button" onclick="selectStructured()">Structured Data</button>
            <button class="cta-button coming-soon" onclick="showComingSoon('Semi-Structured')">Semi-Structured (Coming Soon)</button>
            <button class="cta-button coming-soon" onclick="showComingSoon('Unstructured')">Unstructured (Coming Soon)</button>
        </div>
    </div>
	    <div class="structured-section panel" id="structuredSection">
        <div id="uploadSection">
            <h2 class="section-title">Upload CSV File</h2>
            <div class="upload-area" id="uploadArea" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                <p>Drag and drop your file here, or use Paste from Clipboard</p>
                <div class="upload-options">
                    <button class="upload-option" onclick="document.getElementById('fileInput').click()">Choose File</button>
                    <button class="upload-option" onclick="pasteFromClipboard()">Paste from Clipboard</button>
                </div>
                <input type="file" id="fileInput" accept=".csv" onchange="handleFileUpload(event)" style="display: none;">
            </div>
            <div style="margin-top: 20px; padding: 14px; background: #fafafa; border: 1px solid #d9d9d9;">
                <h3 style="margin: 0 0 10px 0; color: #111; font-size: 14px;">Or try a sample dataset:</h3>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="upload-option" onclick="loadSampleDataset('customer')">Customer Data</button>
                    <button class="upload-option" onclick="loadSampleDataset('employee')">Employee Records</button>
                    <button class="upload-option" onclick="loadSampleDataset('product')">Product Catalog</button>
                    <button class="upload-option" onclick="loadSampleDataset('survey')">Survey Responses</button>
                    <button class="upload-option" onclick="loadSampleDataset('benchmark_messy')" style="background: #fff3cd; color: #856404; font-weight: bold;">Benchmark (Messy)</button>
                </div>
            </div>

        </div>
        <div id="cleaningSection" style="display:none;">
            <h2 class="section-title">Choose Cleaning Method</h2>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="performQuickClean('upper')">Clean & Standardise to UPPERCASE</button>
                <button onclick="performQuickClean('lower')">Clean & Standardise to lowercase</button>
            </div>
        </div>
        <div id="progressSection" style="display:none;">
            <h2 class="section-title">Cleaning in Progress</h2>
            <div id="progressText" style="text-align: center; margin: 20px 0; font-size: 16px;">Starting...</div>
        </div>
        <div id="completeSection" style="display:none;">
            <h2 class="section-title">Cleaning Complete!</h2>
            <p style="text-align: center; margin: 20px 0;">Your data has been successfully cleaned and downloaded.</p>
            <div id="summaryDashboard" style="background: #f4f4f4; border: 1px solid #d9d9d9; padding: 20px; margin: 14px 0; border-radius: 4px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;"></div>
            <div class="results-grid">
                <div id="comparisonSection" style="text-align: left; padding: 15px; background: #ffffff; border: 1px solid #d9d9d9; max-height: 200px; overflow-y: auto;"></div>
                <div id="auditLogSection" style="text-align: left; padding: 15px; background: #ffffff; border: 1px solid #d9d9d9; max-height: 200px; overflow-y: auto;"></div>
                <div id="qualityMetricsSection" style="text-align: left; padding: 15px; background: #ffffff; border: 1px solid #d9d9d9; max-height: 200px; overflow-y: auto;"></div>
                <div id="reproducibilitySection" style="text-align: left; padding: 15px; background: #ffffff; border: 1px solid #d9d9d9; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div id="fairnessAnalysisSection" style="text-align: left; padding: 15px; background: #ffffff; border: 1px solid #d9d9d9; margin: 14px 0; max-height: 300px; overflow-y: auto;"></div>
            <div id="performanceMetricsSection" style="text-align: left; padding: 15px; background: #ffffff; border: 1px solid #d9d9d9; margin: 14px 0;"><strong>Performance Metrics</strong><br><span id="performanceMetricsContent" style="font-size: 12px; color: #555;"></span></div>
            <div style="margin: 20px 0;">
                <h3 style="margin: 0 0 10px 0; color: #111;">Cleaned Data</h3>
                <div class="table-controls">
                    <input type="text" id="tableSearchInput" placeholder="Search data..." style="flex: 1; min-width: 200px;">
                    <select id="tableColumnFilter" style="padding: 6px; border: 1px solid var(--line); font-size: 13px;">
                        <option value="">All columns</option>
                    </select>
                </div>
                <div id="dataTableContainer" class="data-table-container" style="max-height: 400px; overflow-y: auto;"></div>
                <div class="table-pagination">
                    <button id="prevPageBtn" onclick="previousPage()">← Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextPageBtn" onclick="nextPage()">Next →</button>
                </div>
            </div>
            <div style="text-align: center;">
                <button onclick="generateAndDownloadReport()" style="margin-right: 10px;">Download Report (JSON)</button>
                <button onclick="startNewSession()">Clean Another File</button>
            </div>
        </div>
    </div>
	    <div class="cleaning-section panel" id="cleaningSection">
        <h2 class="section-title">Auto-Cleaning in Progress</h2>
        <p>Your data is being automatically cleaned based on the detected issues...</p>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
	        <div id="progressText" style="text-align: center; margin: 10px 0;">Initialising...</div>
        <div class="settings-section">
            <h3>Cleaning Settings</h3>
            <div class="setting-option">
                <label>
                    <input type="checkbox" id="uppercaseSetting" checked> Convert to Uppercase (default)
                </label>
            </div>
            <div class="setting-option">
                <label>
                    <input type="checkbox" id="removeDuplicatesSetting" checked> Remove Duplicates
                </label>
            </div>
            <div class="setting-option">
                <label>
                    <input type="checkbox" id="trimWhitespaceSetting" checked> Trim Whitespace
                </label>
            </div>
            <div class="setting-option">
                <label>
                    <input type="checkbox" id="standardiseNullsSetting" checked> Standardise Null Values
                </label>
            </div>
        </div>
    </div>
	    <div class="result-section panel" id="resultSection">
        <h2 class="section-title">Cleaning Complete!</h2>
        <div class="success-message">
            <h3>Your data has been successfully cleaned</h3>
            <p>The cleaned file has been automatically downloaded to your device.</p>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="startNewSession()">Clean Another File</button>
        </div>
    </div>
	    </main>
	  </div>
    <script src="algorithms.js"></script>
    <script>
        let wasmModule=null;let wasmReady=false;let uploadCSV='';let cleanedCSV='';let originalCSV='';let comparisonData=null;
        const sampleDatasets={customer:'name,email,phone,city,status\njohn smith,john@example.com,555-1234,new york,active\njane doe,jane@example.com,555-5678,los angeles,inactive\njohn smith,john@example.com,555-1234,new york,active\nbob johnson, bob@example.com ,555-9999,chicago,active\nalice williams,alice@example.com,555-4321,new york,pending\n',employee:'employee_id,name,department,salary,hire_date\n001,john smith,engineering,75000,2020-01-15\n002,jane doe,marketing,65000,2019-06-20\n003,bob johnson,engineering,75000,2020-01-15\n004,alice williams,sales,60000,2021-03-10\n005,charlie brown,engineering,75000,2020-01-15\n',product:'product_id,name,category,price,stock\nP001,laptop,electronics,999.99,15\nP002,mouse,electronics,29.99,150\nP003,laptop,electronics,999.99,15\nP004,keyboard,electronics,79.99,45\nP005,monitor,electronics,299.99,8\n',survey:'respondent_id,age,satisfaction,recommendation,comments\n001,25,very satisfied,yes,great product\n002,35,satisfied,yes,good quality\n003,25,very satisfied,yes,great product\n004,45,neutral,no,could be better\n005,28,satisfied,yes,would recommend\n',benchmark_messy:'id,name,email,phone,city,status\n1,John Smith,john@example.com,555-1234,NEW YORK,Active\n2,john smith,john@example.com,555-1234,new york,active\n3,Jane Doe,jane@example.com,555-5678,Los Angeles,Inactive\n4,JANE DOE,jane@example.com,555-5678,los angeles,inactive\n5,Bob Johnson, bob@example.com ,555-9999,Chicago,Active\n6,bob johnson,bob@example.com,555-9999,chicago,active\n7,Alice Williams,alice@example.com,555-4321,New York,Pending\n8,alice williams,alice@example.com,555-4321,new york,pending\n9,Charlie Brown,charlie@example.com,555-6666,Boston,Active\n10,charlie brown,charlie@example.com,555-6666,boston,active\n'};
        AlgorithmsModule().then(module=>{wasmModule=module;wasmReady=true;});
        function showComingSoon(type){alert(`${type} data cleaning is coming soon! Please select "Structured Data" for now.`);}
        function selectStructured(){document.getElementById('welcomeSection').classList.add('hidden');document.getElementById('structuredSection').style.display='block';}
        function loadSampleDataset(datasetName){uploadCSV=sampleDatasets[datasetName];if(uploadCSV){beginProfiling();}else{alert('Sample dataset not found.');}}
        function handleDragOver(e){e.preventDefault();document.getElementById('uploadArea').classList.add('drag-over');}
        function handleDragLeave(e){e.preventDefault();document.getElementById('uploadArea').classList.remove('drag-over');}
        function handleDrop(e){
            e.preventDefault();document.getElementById('uploadArea').classList.remove('drag-over');
            const files=e.dataTransfer.files;
            if(files.length>0){
                const file=files[0];
                if(file.name.endsWith('.csv')){
                    const reader=new FileReader();
                    reader.onload=function(e){uploadCSV=e.target.result;beginProfiling();};
                    reader.readAsText(file);
                }else{alert('Please upload a CSV file.');}
            }
        }
        function handleFileUpload(e){
            const file=e.target.files[0];
            if(file){
                const reader=new FileReader();
                reader.onload=function(e){uploadCSV=e.target.result;beginProfiling();};
                reader.readAsText(file);
            }
        }
        async function pasteFromClipboard(){
            try{
                const text=await navigator.clipboard.readText();
                if(text){uploadCSV=text;beginProfiling();}
            }catch(err){
                console.error('Failed to read clipboard contents: ',err);
                alert('Could not access clipboard. Please try again or use the Choose File button.');
            }
        }
        function beginProfiling(){
            if(!uploadCSV){alert('Please upload or paste CSV data first.');return;}
            document.getElementById('uploadSection').style.display='none';
            document.getElementById('cleaningSection').style.display='block';
        }
        async function performProfiling(){
            const API_URL=window.location.origin;
            let results={};
            if(wasmReady){
                results.rows=wasmModule.ccall('parseCSV','number',['string'],[uploadCSV]);
                results.missing=wasmModule.ccall('detectMissing','number',['string'],[uploadCSV]);
                results.duplicates=wasmModule.ccall('detectDuplicates','number',['string'],[uploadCSV]);
                results.whitespace=wasmModule.ccall('detectWhitespace','number',['string'],[uploadCSV]);
                try{results.nulls=wasmModule.ccall('detectNullValues','number',['string'],[uploadCSV]);}
                catch(e){
                    const nullRes=await fetch(API_URL+'/api/detect-null-values',{method:'POST',headers:{'Content-Type':'text/plain'},body:uploadCSV});
                    const nullData=await nullRes.json();
                    results.nulls=nullData.cellsWithNullValues||0;
                }
            }else{
                const parseRes=await fetch(API_URL+'/api/parse',{method:'POST',body:uploadCSV});
                const parseData=await parseRes.json();
                results.rows=parseData.rows;
                const missingRes=await fetch(API_URL+'/api/detect-missing',{method:'POST',body:uploadCSV});
                const missingData=await missingRes.json();
                results.missing=missingData.missing;
                const dupRes=await fetch(API_URL+'/api/detect-duplicates',{method:'POST',body:uploadCSV});
                const dupData=await dupRes.json();
                results.duplicates=dupData.duplicates;
                const wsRes=await fetch(API_URL+'/api/detect-whitespace',{method:'POST',body:uploadCSV});
                const wsData=await wsRes.json();
                results.whitespace=wsData.cellsWithWhitespace||0;
                const nullRes=await fetch(API_URL+'/api/detect-null-values',{method:'POST',body:uploadCSV});
                const nullData=await nullRes.json();
                results.nulls=nullData.cellsWithNullValues||0;
            }
            displayProfileDetails(results);
        }
        function displayProfileDetails(results){
            const profileDiv=document.getElementById('profileDetails');
            const issuesDiv=document.getElementById('issuesList');
            profileDiv.innerHTML=`<h3>Data Summary</h3><p><strong>Total Rows:</strong> ${results.rows||0}</p><p><strong>Total Columns:</strong> ${getColumnCount(uploadCSV)}</p><p><strong>File Size:</strong> ${(new Blob([uploadCSV]).size/1024).toFixed(2)} KB</p>`;
            let issuesHtml='<h3>Detected Issues</h3><ul>';
            let issueCount=0;
            if(results.missing>0){issuesHtml+=`<li>Missing values: ${results.missing} cells</li>`;issueCount++;}
            if(results.duplicates>0){issuesHtml+=`<li>Duplicate rows: ${results.duplicates} rows</li>`;issueCount++;}
            if(results.whitespace>0){issuesHtml+=`<li>Whitespace issues: ${results.whitespace} cells</li>`;issueCount++;}
            if(results.nulls>0){issuesHtml+=`<li>Null/empty values: ${results.nulls} cells</li>`;issueCount++;}
            if(issueCount===0){issuesHtml+='<li>No issues detected - your data looks clean!</li>';}
            issuesHtml+='</ul>';
            issuesDiv.innerHTML=issuesHtml;
        }
        function getColumnCount(csv){if(!csv)return 0;const firstLine=csv.split('\n')[0];if(!firstLine)return 0;return firstLine.split(',').length;}
        function startQuickClean(){
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('quickCleanSection').style.display='block';
        }
        function startAutoCleaning(){document.getElementById('profileSection').classList.add('hidden');document.getElementById('cleaningSection').style.display='block';performAutoCleaning();}
        async function performAutoCleaning(){
            const API_URL=window.location.origin;
            let current=uploadCSV;
            let progress=0;
            const totalSteps=5;
            function updateProgress(step,message){progress=Math.floor((step/totalSteps)*100);document.getElementById('progressBar').style.width=progress+'%';document.getElementById('progressText').textContent=message;}
            updateProgress(0,'Starting auto-cleaning...');
            try{
                updateProgress(1,'Removing duplicates...');
                if(document.getElementById('removeDuplicatesSetting').checked){
                    if(wasmReady){current=wasmModule.ccall('cleanDataString','string',['string'],[current]);}
                    else{const res=await fetch(API_URL+'/api/clean',{method:'POST',headers:{'Content-Type':'text/plain'},body:current});const data=await res.json();current=data.cleaned||current;}
                }
                updateProgress(2,'Trimming whitespace...');
                if(document.getElementById('trimWhitespaceSetting').checked){
                    if(wasmReady){current=wasmModule.ccall('trimWhitespaceString','string',['string'],[current]);}
                    else{const res=await fetch(API_URL+'/api/trim-whitespace',{method:'POST',headers:{'Content-Type':'text/plain'},body:current});const data=await res.json();current=data.cleaned||current;}
                }
                updateProgress(3,'Standardising null values...');
                if(document.getElementById('standardiseNullsSetting').checked){
                    if(wasmReady){current=wasmModule.ccall('standardiseNullValueString','string',['string'],[current]);}
                    else{const res=await fetch(API_URL+'/api/standardise-null-values',{method:'POST',headers:{'Content-Type':'text/plain'},body:current});const data=await res.json();current=data.cleaned||current;}
                }
                updateProgress(4,'Converting to uppercase...');
                if(document.getElementById('uppercaseSetting').checked){
                    if(wasmReady){current=wasmModule.ccall('toUpperCaseString','string',['string'],[current]);}
                    else{const res=await fetch(API_URL+'/api/to-uppercase',{method:'POST',headers:{'Content-Type':'text/plain'},body:current});const data=await res.json();current=data.cleaned||current;}
                }
                updateProgress(5,'Finalising cleaned data...');
                cleanedCSV=current;
                setTimeout(()=>{document.getElementById('cleaningSection').classList.add('hidden');document.getElementById('resultSection').style.display='block';triggerDownload();},1000);
            }catch(error){
                console.error('Error during auto-cleaning:',error);
                alert('An error occurred during the cleaning process. Please try again.');
                updateProgress(5,'Error occurred - cleaning incomplete');
            }
        }
        function showCleaningComplete(){
            document.getElementById('progressSection').style.display='none';
            document.getElementById('completeSection').style.display='block';
            renderDataTable();
            if(comparisonData){
                const html='<strong>Before/After Comparison</strong><br><br>Original rows: '+comparisonData.originalRows+'<br>Cleaned rows: '+comparisonData.cleanedRows+'<br>Rows removed: '+comparisonData.rowsRemoved+'<br>Cells modified: '+comparisonData.cellsModified;
                document.getElementById('comparisonSection').innerHTML=html;
            }
            fetchAndDisplayAuditLog();
            fetchAndDisplayQualityMetrics();
            fetchAndDisplayReproducibility();
            fetchAndDisplayFairnessAnalysis();
            fetchAndDisplayPerformanceMetrics();
            triggerDownload();
        }
        async function fetchAndDisplayAuditLog(){
            try{
                const API_URL=window.location.origin;
                const res=await fetch(API_URL+'/api/get-audit-log');
                const data=await res.json();
                if(data.operations&&data.operations.length>0){
                    let html='<strong>Operation History</strong><br><br>';
                    for(const op of data.operations){
                        html+=op.operationName+': '+op.cellsAffected+' cells affected ('+op.rowsBefore+' → '+op.rowsAfter+' rows)<br>';
                    }
                    document.getElementById('auditLogSection').innerHTML=html;
                }
            }catch(err){
                console.error('Error fetching audit log:',err);
            }
        }
        async function fetchAndDisplayQualityMetrics(){
            try{
                const API_URL=window.location.origin;
                const res=await fetch(API_URL+'/api/quality-metrics',{method:'POST',body:uploadCSV});
                const data=await res.json();
                const html='<strong>Data Quality Metrics</strong><br><br>Completeness: '+data.completeness+'%<br>Uniqueness: '+data.uniqueness+'%<br>Missing cells: '+data.missingCells+'<br>Duplicate rows: '+data.duplicateRows+'<br>Total rows: '+data.totalRows+'<br>Total columns: '+data.totalColumns;
                document.getElementById('qualityMetricsSection').innerHTML=html;
            }catch(err){
                console.error('Error fetching quality metrics:',err);
            }
        }
        async function fetchAndDisplayReproducibility(){
            try{
                const API_URL=window.location.origin;
                const body={csvData:uploadCSV,fuzzyThreshold:0.75,removeDuplicates:true};
                const res=await fetch(API_URL+'/api/verify-reproducibility',{method:'POST',body:JSON.stringify(body),headers:{'Content-Type':'application/json'}});
                const data=await res.json();
                const status=data.reproducible?'✓ Reproducible':'✗ Not Reproducible';
                const html='<strong>Reproducibility Verification</strong><br><br>Status: '+status+'<br>Message: '+data.message;
                document.getElementById('reproducibilitySection').innerHTML=html;
            }catch(err){
                console.error('Error verifying reproducibility:',err);
            }
        }
        async function fetchAndDisplayFairnessAnalysis(){
            try{
                const API_URL=window.location.origin;
                const res=await fetch(API_URL+'/api/fairness-analysis',{method:'POST',body:cleanedCSV});
                const data=await res.json();
                if(data.analysis&&data.analysis.length>0){
                    let html='<strong>Fairness Analysis</strong><br><br>';
                    for(const col of data.analysis){
                        html+='<strong>'+col.columnName+'</strong>';
                        if(col.isDemographic)html+=' <em style="color:#d9534f">[Demographic Data]</em>';
                        html+='<br>';
                        for(const item of col.distribution){
                            let warning='';
                            if(item.imbalanced)warning=' ⚠️ Imbalanced';
                            html+=item.value+': '+item.count+' ('+item.percentage+'%)'+warning+'<br>';
                        }
                        html+='<br>';
                    }
                    document.getElementById('fairnessAnalysisSection').innerHTML=html;
                }else{
                    document.getElementById('fairnessAnalysisSection').innerHTML='<strong>Fairness Analysis</strong><br><br>No categorical columns detected for fairness analysis.';
                }
            }catch(err){
                console.error('Error fetching fairness analysis:',err);
            }
        }
        async function fetchAndDisplayPerformanceMetrics(){try{const API_URL=window.location.origin;const res=await fetch(API_URL+'/api/measure-performance',{method:'POST',body:uploadCSV});const data=await res.json();if(data.metrics){let html='Execution Time: '+data.metrics.executionTimeMs.toFixed(2)+'ms<br>';html+='Rows: '+data.metrics.rows+' | Columns: '+data.metrics.columns+' | Total Cells: '+data.metrics.totalCells+'<br>';html+='Processing Speed: '+data.metrics.cellsPerSecond+' cells/sec<br>';html+='Missing Values: '+data.metrics.missingValues+' | Duplicate Rows: '+data.metrics.duplicateRows+'<br>';html+='Cleaned Rows: '+data.metrics.cleanedRows;document.getElementById('performanceMetricsContent').innerHTML=html;}else{document.getElementById('performanceMetricsContent').innerHTML='No performance data available.';}}catch(err){console.error('Error fetching performance metrics:',err);}}
        async function generateAndDownloadReport(){try{const API_URL=window.location.origin;const res=await fetch(API_URL+'/api/generate-report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({originalCSV:uploadCSV,cleanedCSV:cleanedCSV})});const data=await res.json();const reportBlob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=window.URL.createObjectURL(reportBlob);const a=document.createElement('a');a.href=url;a.download='cleaning_report_'+new Date().getTime()+'.json';document.body.appendChild(a);a.click();document.body.removeChild(a);window.URL.revokeObjectURL(url);}catch(err){console.error('Error generating report:',err);alert('Failed to generate report');}}

        function triggerDownload(){
            const blob=new Blob([cleanedCSV],{type:'text/csv'});
            const url=window.URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;a.download='cleaned_data.csv';
            document.body.appendChild(a);a.click();document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        function startNewSession(){
            document.getElementById('uploadSection').style.display='block';
            document.getElementById('cleaningSection').style.display='none';
            document.getElementById('progressSection').style.display='none';
            document.getElementById('completeSection').style.display='none';
            document.getElementById('fileInput').value='';
            uploadCSV='';cleanedCSV='';
        }
        function showFaceting(){
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('facetingSection').style.display='block';
            populateColumnSelector();
        }
        function backToProfile(){
            document.getElementById('facetingSection').classList.add('hidden');
            document.getElementById('profileSection').style.display='block';
        }
        function populateColumnSelector(){
            if(!uploadCSV)return;
            const firstLine=uploadCSV.split('\n')[0];
            const columns=firstLine.split(',');
            let html='<label>Select column to view facets: <select id="columnSelect" onchange="displayFacets()">';
            columns.forEach((col,idx)=>{html+=`<option value="${idx}">${col.trim()}</option>`;});
            html+='</select></label>';
            document.getElementById('columnSelector').innerHTML=html;
            displayFacets();
        }
        async function displayFacets(){
            const colIndex=parseInt(document.getElementById('columnSelect').value);
            const profile=await profileColumnData(colIndex);
            let html='<h3>Unique Values</h3><ul>';
            if(profile.values){
                const sorted=Object.entries(profile.values).sort((a,b)=>b[1]-a[1]);
                sorted.forEach(([value,count])=>{
                    const displayValue=value||'(empty)';
                    html+=`<li>${displayValue}: <strong>${count}</strong> occurrence${count!==1?'s':''}</li>`;
                });
            }
            html+='</ul>';
            document.getElementById('facetResults').innerHTML=html;
        }
        async function profileColumnData(colIndex){
            const API_URL=window.location.origin;
            if(wasmReady){
                const result=wasmModule.ccall('profileColumn','string',['string','number'],[uploadCSV,colIndex]);
                return JSON.parse(result);
            }else{
                const res=await fetch(API_URL+'/api/profile-column',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({csvData:uploadCSV,colIndex:colIndex})});
                return await res.json();
            }
        }
        async function standardiseCase(caseType){
            const colIndex=parseInt(document.getElementById('columnSelect').value);
            const API_URL=window.location.origin;
            if(wasmReady){
                const result=wasmModule.ccall('testStandardize','string',['string','number','string'],[uploadCSV,colIndex,caseType]);
                uploadCSV=result;
            }else{
                const res=await fetch(API_URL+'/api/standardize-column-case',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({csvData:uploadCSV,colIndex:colIndex,caseType:caseType})});
                const data=await res.json();
                uploadCSV=data.csvData;
            }
            displayFacets();
        }
        async function removeEmptyRows(){
            const API_URL=window.location.origin;
            if(wasmReady){
                const result=wasmModule.ccall('removeEmptyRowsString','string',['string'],[uploadCSV]);
                uploadCSV=result;
            }else{
                const res=await fetch(API_URL+'/api/remove-empty-rows',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({csvData:uploadCSV})});
                const data=await res.json();
                uploadCSV=data.csvData;
            }
            displayFacets();
        }
        async function removeDuplicates(){
            const API_URL=window.location.origin;
            if(wasmReady){
                const result=wasmModule.ccall('removeAllDuplicatesString','string',['string'],[uploadCSV]);
                uploadCSV=result;
            }else{
                const res=await fetch(API_URL+'/api/remove-duplicates',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({csvData:uploadCSV})});
                const data=await res.json();
                uploadCSV=data.csvData;
            }
            displayFacets();
        }
        async function performQuickClean(caseType){
            document.getElementById('cleaningSection').style.display='none';
            document.getElementById('progressSection').style.display='block';
            const API_URL=window.location.origin;
            let current=uploadCSV;
            originalCSV=uploadCSV;
            function updateProgress(message){document.getElementById('progressText').textContent=message;}
            try{
                updateProgress('Cleaning data with fuzzy matching...');
                const fileSizeInMB=new Blob([current]).size/(1024*1024);
                console.log('File size: '+fileSizeInMB+'MB, wasmReady: '+wasmReady);
                const useAPI=true;
                console.log('Using API: '+useAPI);
                if(useAPI){
                    console.log('Calling API endpoint /api/universal-clean');
                    const res=await fetch(API_URL+'/api/universal-clean',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({csvData:current,fuzzyThreshold:0.75,removeDuplicates:true})});
                    const data=await res.json();
                    current=data.csvData;
                    console.log('API returned cleaned data');
                    console.log('Original rows: '+data.originalRows+', Cleaned rows: '+data.cleanedRows+', Removed rows: '+data.removedRows);
                }
                uploadCSV=current;
                cleanedCSV=current;
                console.log('cleanedCSV set, length: '+cleanedCSV.length);
                try{
                    const compareRes=await fetch(API_URL+'/api/compare',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({originalCSV:originalCSV,cleanedCSV:cleanedCSV})});
                    console.log('Compare response status: '+compareRes.status);
                    comparisonData=await compareRes.json();
                    console.log('Comparison: rows removed='+comparisonData.rowsRemoved+', cells modified='+comparisonData.cellsModified);
                }catch(compareErr){
                    console.error('Error getting comparison:',compareErr);
                }
                showCleaningComplete();
            }catch(err){
                console.error('Error during universal clean:',err);
                updateProgress('Error during cleaning. Please try again.');
            }
        }
        let currentPage=1;
        const rowsPerPage=50;
        let tableData=[];
        let filteredData=[];
        function renderDataTable(){
            if(!cleanedCSV){console.error('No cleaned CSV data');return;}
            const lines=cleanedCSV.trim().split('\n');
            if(lines.length===0){console.error('Empty CSV');return;}
            const headers=lines[0].split(',');
            tableData=[];
            for(let i=1;i<lines.length;i++){
                const cells=lines[i].split(',');
                tableData.push(cells);
            }
            filteredData=tableData.slice();
            currentPage=1;
            updateColumnFilter(headers);
            updateTableDisplay(headers);
        }
        function updateColumnFilter(headers){
            const select=document.getElementById('tableColumnFilter');
            select.innerHTML='<option value="">All columns</option>';
            headers.forEach((header,idx)=>{
                const opt=document.createElement('option');
                opt.value=idx;
                opt.textContent=header.trim();
                select.appendChild(opt);
            });
        }
        function filterTable(){
            const searchInput=document.getElementById('tableSearchInput').value.toLowerCase();
            const columnFilter=document.getElementById('tableColumnFilter').value;
            const lines=cleanedCSV.trim().split('\n');
            const headers=lines[0].split(',');
            tableData=[];
            for(let i=1;i<lines.length;i++){
                const cells=lines[i].split(',');
                tableData.push(cells);
            }
            filteredData=tableData.filter(row=>{
                if(columnFilter===''){
                    return row.some(cell=>cell.toLowerCase().includes(searchInput));
                }else{
                    const colIdx=parseInt(columnFilter);
                    return row[colIdx]&&row[colIdx].toLowerCase().includes(searchInput);
                }
            });
            currentPage=1;
            updateTableDisplay(headers);
        }
        function updateTableDisplay(headers){
            const start=(currentPage-1)*rowsPerPage;
            const end=start+rowsPerPage;
            const pageData=filteredData.slice(start,end);
            let html='<table class=\"data-table\"><thead><tr>';
            headers.forEach(h=>{html+='<th>'+h.trim()+'</th>';});
            html+='</tr></thead><tbody>';
            pageData.forEach(row=>{
                html+='<tr>';
                row.forEach(cell=>{html+='<td>'+cell.trim()+'</td>';});
                html+='</tr>';
            });
            html+='</tbody></table>';
            document.getElementById('dataTableContainer').innerHTML=html;
            const totalPages=Math.ceil(filteredData.length/rowsPerPage);
            document.getElementById('pageInfo').textContent='Page '+currentPage+' of '+totalPages;
            document.getElementById('prevPageBtn').disabled=currentPage===1;
            document.getElementById('nextPageBtn').disabled=currentPage===totalPages;
        }
        function nextPage(){
            const totalPages=Math.ceil(filteredData.length/rowsPerPage);
            if(currentPage<totalPages){
                currentPage++;
                const lines=cleanedCSV.trim().split('\n');
                const headers=lines[0].split(',');
                updateTableDisplay(headers);
            }
        }
        function previousPage(){
            if(currentPage>1){
                currentPage--;
                const lines=cleanedCSV.trim().split('\n');
                const headers=lines[0].split(',');
                updateTableDisplay(headers);
            }
        }
        document.addEventListener('DOMContentLoaded',()=>{const searchInput=document.getElementById('tableSearchInput');const columnFilter=document.getElementById('tableColumnFilter');if(searchInput){searchInput.addEventListener('input',filterTable);}if(columnFilter){columnFilter.addEventListener('change',filterTable);}});
        if('serviceWorker'in navigator){
            navigator.serviceWorker.getRegistrations().then(registrations=>{
                for(let reg of registrations){reg.unregister();}
            });
            caches.keys().then(cacheNames=>{
                cacheNames.forEach(cacheName=>{caches.delete(cacheName);});
            });
            navigator.serviceWorker.register('service-worker.js').then(registration=>{console.log('Service Worker registered with scope:',registration.scope);}).catch(error=>{console.log('Service Worker registration failed:',error);});
        }
    </script>
</body>
</html>